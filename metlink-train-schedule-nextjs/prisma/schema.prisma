// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Historical departure data for analytics
model HistoricalDeparture {
  id          String   @id @default(cuid())
  serviceId   String
  stopId      String
  station     String?
  destination String
  destinationStopId String
  aimedTime   DateTime
  expectedTime DateTime?
  status      String?
  createdAt   DateTime @default(now())
  
  @@index([serviceId])
  @@index([stopId])
  @@index([station])
  @@index([aimedTime])
  @@index([createdAt])
  @@map("historical_departures")
}

// Cache entries for API responses
model CacheEntry {
  id        String   @id @default(cuid())
  key       String   @unique
  data      Json
  timestamp DateTime @default(now())
  expiresAt DateTime
  
  @@index([key])
  @@index([expiresAt])
  @@map("cache_entries")
}

// Performance metrics for monitoring
model PerformanceMetric {
  id            String   @id @default(cuid())
  endpoint      String
  method        String
  statusCode    Int
  responseTime  Int       // milliseconds
  requestSize   Int?      // bytes
  responseSize  Int?      // bytes
  errorMessage  String?
  createdAt     DateTime @default(now())
  
  @@index([endpoint])
  @@index([method])
  @@index([statusCode])
  @@index([createdAt])
  @@map("performance_metrics")
}

// API request metrics
model ApiRequestMetric {
  id            String   @id @default(cuid())
  endpoint      String
  method        String
  statusCode    Int
  responseTime  Int       // milliseconds
  cacheHit      Boolean  @default(false)
  errorMessage  String?
  createdAt     DateTime @default(now())
  
  @@index([endpoint])
  @@index([createdAt])
  @@map("api_request_metrics")
}

// User preferences - identified by client-generated userId
model User {
  id            String   @id @default(cuid())
  userId        String   @unique // Client-generated identifier
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  preferences   UserPreferences?
  scheduleConfigs ScheduleConfig[]
  
  @@index([userId])
  @@map("users")
}

// User alert preferences
model UserPreferences {
  id                String   @id @default(cuid())
  userInternalId    String   @unique
  user              User     @relation(fields: [userInternalId], references: [id], onDelete: Cascade)
  
  alertsEnabled     Boolean  @default(false)
  notifyOnDelay     Boolean  @default(true)
  notifyOnCancellation Boolean @default(true)
  notifyOnApproaching Boolean @default(false)
  approachingMinutes Int      @default(5)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("user_preferences")
}

// Schedule configurations (favorites)
model ScheduleConfig {
  id              String   @id @default(cuid())
  userInternalId  String
  user            User     @relation(fields: [userInternalId], references: [id], onDelete: Cascade)
  
  name            String
  line            String   // LineCode (WRL, KPL, HVL, JVL)
  selectedStations Json    // Array of station strings
  direction       String   // 'inbound' | 'outbound'
  
  // Filter preferences
  selectedStation String?
  routeFilter     String   @default("all") // 'all' | 'express' | 'all-stops'
  sortOption      String   @default("time") // SortOption
  sortDirection   String   @default("asc")  // 'asc' | 'desc'
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userInternalId])
  @@index([line])
  @@map("schedule_configs")
}
